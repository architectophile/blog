# [AWS] EC2 인스턴스 SSH 키 잃어버렸을 때 교체하는 법

<br/>

## 1. 서론

AWS의 EC2 인스턴스의 쉘에 접속하기 위해서는 등록된 ***개인키(.pem)를 사용해야 한다.*** 최초 인스턴스를 생성할 때 키를 새로 생성하거나 또는 기존에 사용하던 키를 등록한 뒤, 인스턴스를 시작하게 된다. 하지만 실수로 ***키를 삭제하거나 잃어버렸을 경우***에는 더 이상 해당 인스턴스 쉘에 접속할 수 없다. 따라서 이런 경우 어떻게 키를 잃어버린 인스턴스에 ***새로운 키를 등록하여 다시 그 인스턴스에 접속***할 수 있는지 알아보도록 하자.

<br/>

## 2. 인스턴스 이름

이 글에서는 간결한 설명을 위해서 현재 키를 잃어버린 인스턴스의 이름을 ***`인스턴스 K(key)`***라고 부르고, 새로운 키를 등록하기 위해서 잠시동안 임시로 생성할 인스턴스의 이름을 ***`인스턴스 T(temporary)`***라고 부르도록 하겠다.

<br/>

## 3. 인스턴스 키 변경방법

<br/>

### 1) 새로운 인스턴스 T 생성 및 시작

우선은 새로운 키를 생성하여 등록하기 위한 임시의 `인스턴스 T`를 생성한다. 가격이 저렴한 `t2.micro` 인스턴스를 생성하고 `새 키 페어`를 생성하여 등록한 뒤 ***`인스턴스 T`를 시작한다.***

<br/>

### 2) 인스턴스 중지

AWS 콘솔(console)에 로그인하여 해당 인스턴스가 있는 리전(region)의 대시보드(dashboard)로 이동한다. 그리고 키를 잃어버린 `인스턴스 K`를 선택한 뒤, `인스턴스 상태` → `중지`를 선택하여 ***`인스턴스 K`를 중지시킨다.***

<br/>

### 3) EBS 볼륨 분리

EC2 대시보드에서 `인스턴스 K`를 선택하고 아래의 `설명` 탭에서 `루트 디바이스`(e.g. /dev/sda1)를 클릭하고 연결된 볼륨의 `EBS ID`(e.g. vol-08d84317bb7f68eaf)를 클릭하여 해당 인스턴스의 연결된 볼륨 관리 페이지로 이동한다.

> ***Note:***  
위 과정에서 해당 `루트 디바이스`의 경로(일반적인 루트 디바이스 경로는 `/dev/sda1`이며, 장치마다 다를 수 있다.)를 잘 알아놓도록 한다.

그 다음 해당 볼륨을 선택하고 `작업` → `볼륨 분리`를 클릭하여 ***`인스턴스 K`로부터 볼륨을 분리한다.***

<br/>

### 4) 인스턴스 T에 볼륨 연결

이제 해당 볼륨이 분리되어 현재 상태가 `available`로 바뀐 것을 확인한다. 

그리고 해당 볼륨을 선택하고 `작업` → `볼륨 연결`을 클릭한 뒤 처음 과정에서 생성했던 ***`인스턴스 T`에 볼륨을 연결한다.***

<br/>

### 5) 볼륨 마운트

<br/>

#### (1) 인스턴스 T의 쉘 접속

<br/>

#### (2) 연결된 디바이스 확인

```shell
foo@bar:~$ sudo fdisk -l
```

→ `/dev/xvdf1`와 같은 경로의 아직 마운트되지 않은 새로운 장치를 확인한다.

<br/>

#### (3) 마운트 포인트 생성

```shell
foo@bar:~$ sudo mkdir /mnt/tmp
```

<br/>

#### (4) 장치 마운트

```shell
foo@bar:~$ sudo mount /dev/xvdf1 /mnt/tmp
```

<br/>

### 6) SSH 키 복사

`인스턴스 T`의 SSH 키를 기존의 `인스턴스 K`에서 분리된 볼륨에 복사한다.

```shell
foo@bar:~$ sudo cp ~/.ssh/authorized_keys /mnt/tmp/home/ubuntu/.ssh/authorized_keys
```

> ***Note:***  
위 명령을 실행하면 새로운 키를 복사하여 기존의 볼륨에 존재하던 `authorized_keys`를 덮어쓰게 된다. 그리고 잃어버렸던 기존의 키는 더 이상 사용하지 못하게 된다.

<br/>

### 7) 인스턴스 T 중지 및 볼륨 재연결

이제 ***`인스턴스 T`를 중지***하고 새로운 키가 복사된 ***볼륨을 분리***한다. 그리고 그 볼륨을 ***원래대로 `인스턴스 K`에 다시 연결한다.***

<br/>

### 8) 인스턴스 K 시작 및 새로 등록한 키로 SSH 접속

이제 ***원래의 `인스턴스 K`를 다시 시작한다.*** 그리고 새로 생성한 키로 쉘에 접속하여 정상적으로 동작하는지 확인한다.

새로운 키가 정상적으로 동작하는 것을 확인한 후 ***`인스턴스 T`를 삭제한다.***

<br/>

## 4. 결론

이 방법을 사용하면 EC2 인스턴스의 키를 잃어버렸을 때 새로운 키 페어를 생성하여 안전하게 등록할 수 있다. 실수로 키를 잃어버렸거나 또는 키가 오래되어서 새로운 키로 교체해야 할 때 이 방법을 사용하면 ***기존의 EC2 인스턴스 서버를 그대로 사용***하면서도 큰 위험부담 없이 ***매우 안전하고 간단하게 키를 변경할 수 있다.***

<br/>

<br/>

---

### References

\[1\] *tamoyal. (2017). [Transitioning your pem/key on an EC2 instance][1] [Github Gist]*

[1]: https://gist.github.com/tamoyal/1b7ec4d3871b343d353d

\[2\] *Eddie. (2015, Nov 15). [Change key pair for ec2 instance][2] [StackOverflow Answer]*

[2]: https://stackoverflow.com/questions/7881469/change-key-pair-for-ec2-instance

<br/>

---

### Hashtags

`#아마존 웹 서비스` `#아마존 EC2 서버` `#아마존 웹 서비스 EC2` `#아마존 웹 서비스 키 잃어버렸을 때` `#아마존 웹 서비스 키 복구` `#아마존 웹 서비스 EC2 키` `#아마존 키 복구` `#아마존 서버 키` `#아마존 서버 키 변경` `#aws` `#amazon ec2` `#aws ec2 key` `#aws key lost` `#aws key recovery` `#aws key transition` `#amazon private key` `#aws ssh key` `#aws ssh key change` `#aws server key` `#aws ec2 key lost` `#aws locked out` `#aws server locked out` `#aws ssh key lost`
